<!DOCTYPE html>
<html>
  <head>
    <title>Bainbridge CTF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
      :root{--blue:#0b69ff;--red:#dc3b3b;--gray:#666;}
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
      #app{height:100%}
      #topbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);
        background:rgba(255,255,255,0.95);border-radius:12px;padding:10px 16px;
        font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,.15);
        display:flex;gap:12px;align-items:center;z-index:1000;}
      #firebaseStatus{font-size:13px;color:#333;opacity:1;transition:opacity 1s ease}
      #firebaseStatus.hide{opacity:0}
      #teamLabel{padding:6px 10px;border-radius:6px;font-weight:700;color:#fff}
      .blue{background:var(--blue)} .red{background:var(--red)} .gray{background:var(--gray)}
      #map{position:absolute;inset:0}
      .notify{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
        background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:8px;
        font-weight:600;opacity:0;pointer-events:none;transition:opacity .4s,transform .4s;z-index:1000;}
      .notify.show{opacity:1;transform:translate(-50%,-10px)}
      #lobby{height:100%;display:flex;align-items:center;justify-content:center;
        background:linear-gradient(180deg,#f7f9fc,#eef2f7);padding:20px;}
      .card{width:min(960px,100%);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px;}
      .row{display:grid;grid-template-columns:1fr;gap:16px}
      @media(min-width:800px){.row{grid-template-columns:1.2fr .8fr}}
      .section{padding:14px 16px;border:1px solid #eaecef;border-radius:12px}
      h1{margin:0 0 10px;font-size:20px}
      h2{margin:0 0 8px;font-size:16px;color:#333}
      .nameBox{display:flex;gap:10px}
      .nameBox input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #d5d8dd;font-size:15px}
      .btn{border:0;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;background:#111;color:#fff}
      .btn.secondary{background:#f3f4f6;color:#111}
      .btn.blue{background:var(--blue)} .btn.red{background:var(--red)}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .teams{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .teamPanel{border:1px solid #e9ecf1;border-radius:12px;overflow:hidden}
      .teamHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;color:#fff}
      .teamHead.blue{background:var(--blue)} .teamHead.red{background:var(--red)}
      .teamList{padding:8px 12px;min-height:120px}
      .player{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
      .player:last-child{border-bottom:0}
      .check{color:#1a7f37}
      .you{font-size:12px;color:#555;margin-left:6px}
      .actions{display:flex;gap:8px;flex-wrap:wrap}
      .meta{font-size:13px;color:#444}
      .readyBar{margin-top:10px;background:#f1f3f6;border-radius:10px;overflow:hidden;height:10px}
      .readyFill{background:#16a34a;height:100%;width:0%}
      .countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
        background:rgba(0,0,0,.65);color:#fff;font-size:64px;font-weight:800;z-index:2000}
      .countdown.show{display:flex}
      .hidden{display:none !important}
      #progressBlock{height:100%;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:600}
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Lobby -->
      <div id="lobby">
        <div class="card">
          <div class="row">
            <div class="section">
              <h1>Join the Game</h1>
              <div id="nameArea" class="nameBox">
                <input id="playerNameInput" placeholder="Enter your name…" maxlength="24"/>
                <button id="saveNameBtn" class="btn">Save</button>
              </div>
              <div id="afterName" class="hidden">
                <div class="actions" style="margin:10px 0">
                  <button id="joinBlue" class="btn blue">Join Blue Team</button>
                  <button id="joinRed" class="btn red">Join Red Team</button>
                  <button id="cancelTeamBtn" class="btn secondary hidden">Cancel</button>
                  <button id="readyBtn" class="btn secondary" disabled>Ready</button>
                  <button id="unreadyBtn" class="btn secondary hidden">Unready</button>
                </div>
                <div class="meta" id="youMeta">You haven’t joined a team yet.</div>
              </div>
            </div>
            <div class="section">
              <h2>Game Status</h2>
              <div class="meta" id="statusLine">Waiting for players…</div>
              <div class="readyBar"><div id="readyFill" class="readyFill"></div></div>
              <div class="actions" style="margin-top:10px">
                <button id="startBtn" class="btn" disabled>Start Game</button>
                <div class="meta" id="startCount">(0/0 players started)</div>
              </div>
            </div>
          </div>
          <div class="section" style="margin-top:12px">
            <div class="teams">
              <div class="teamPanel"><div class="teamHead blue"><div>Blue Team</div><div id="blueCount">0</div></div><div id="blueList" class="teamList"></div></div>
              <div class="teamPanel"><div class="teamHead red"><div>Red Team</div><div id="redCount">0</div></div><div id="redList" class="teamList"></div></div>
            </div>
          </div>
        </div>
      </div>
      <div id="progressBlock" class="hidden">Game in Progress — please wait…</div>
      <div id="countdown" class="countdown">3</div>
      <!-- Map Phase -->
      <div id="mapPhase" class="hidden">
        <div id="topbar">
          <span id="firebaseStatus">⏳ Connecting...</span>
          <span id="teamLabel" class="blue">Waiting for location…</span>
        </div>
        <div id="notify" class="notify">Crossed line</div>
        <div id="map"></div>
        <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
      </div>
    </div>
    <!-- Firebase + Lobby/Game Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getDatabase, ref, onValue, set, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      // --- Firebase init ---
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "bainbridge-ctf.firebaseapp.com",
        projectId: "bainbridge-ctf",
        storageBucket: "bainbridge-ctf.firebasestorage.app",
        messagingSenderId: "627748791933",
        appId: "1:627748791933:web:3c31d762cbaecb7effb314"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const GAME_ID="default";
      const playersRef=ref(db,`games/${GAME_ID}/players`);
      const stateRef=ref(db,`games/${GAME_ID}/state`);

      // --- Identify player ---
      let playerId=localStorage.getItem("ctf_player_id");
      if(!playerId){playerId="p_"+Math.random().toString(36).slice(2,10);localStorage.setItem("ctf_player_id",playerId);}
      onDisconnect(ref(db,`games/${GAME_ID}/players/${playerId}`)).remove();

      // --- DOM elements ---
      const nameInput=document.getElementById("playerNameInput");
      const saveNameBtn=document.getElementById("saveNameBtn");
      const afterName=document.getElementById("afterName");
      const joinBlue=document.getElementById("joinBlue");
      const joinRed=document.getElementById("joinRed");
      const cancelTeamBtn=document.getElementById("cancelTeamBtn");
      const readyBtn=document.getElementById("readyBtn");
      const voteBtn=document.createElement("button");
      voteBtn.id="voteBtn"; voteBtn.className="btn secondary hidden"; voteBtn.textContent="Vote to Start";
      afterName.querySelector(".actions").appendChild(voteBtn);

      const startBtn=document.getElementById("startBtn");
      const statusLine=document.getElementById("statusLine");
      const readyFill=document.getElementById("readyFill");
      const startCount=document.getElementById("startCount");
      const blueList=document.getElementById("blueList");
      const redList=document.getElementById("redList");
      const blueCount=document.getElementById("blueCount");
      const redCount=document.getElementById("redCount");
      const youMeta=document.getElementById("youMeta");
      const lobby=document.getElementById("lobby");
      const mapPhase=document.getElementById("mapPhase");
      const countdownEl=document.getElementById("countdown");
      const progressBlock=document.getElementById("progressBlock");

      // --- Ensure player record ---
      async function ensurePlayer(nameIfAny){
        const name=nameIfAny ?? nameInput.value.trim();
        if(!name) return;
        await set(ref(db,`games/${GAME_ID}/players/${playerId}`),{
          name,team:null,ready:false,voted:false,started:false,ts:serverTimestamp()
        });
        afterName.classList.remove("hidden");
        nameInput.disabled=true; saveNameBtn.disabled=true;
        localStorage.setItem("ctf_player_name",name);
      }
      saveNameBtn.onclick=()=>ensurePlayer();
      nameInput.addEventListener("keydown",e=>{if(e.key==="Enter")ensurePlayer();});
      const storedName=localStorage.getItem("ctf_player_name")||"";
      if(storedName){nameInput.value=storedName; ensurePlayer(storedName);}

      // --- Team selection ---
      joinBlue.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{team:"blue"});
      joinRed.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{team:"red"});
      cancelTeamBtn.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{team:null,ready:false,voted:false});

      // --- Ready + Vote ---
      readyBtn.onclick=()=>{
        update(ref(db,`games/${GAME_ID}/players/${playerId}`),{ready:true});
      };
      voteBtn.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{voted:true});

      startBtn.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{started:true});

      // --- Watch players ---
      onValue(playersRef,snap=>{
        const players=snap.val()||{};
        const arr=Object.entries(players)
          .map(([id,p])=>({...p,id}))
          .filter(p=>p.name && p.name.trim()!==""); // skip phantom entries

        blueList.innerHTML=""; redList.innerHTML="";
        let blue=0,red=0,voteCount=0,total=arr.length;

        arr.forEach(p=>{
          const el=document.createElement("div");
          el.className="player";
          el.textContent=p.name;
          if(p.ready){const c=document.createElement("span");c.textContent="✔";c.className="check";el.appendChild(c);}
          if(p.voted){const v=document.createElement("span");v.textContent="★";v.style.color="gold";el.appendChild(v);}
          if(p.id===playerId){const y=document.createElement("span");y.textContent="(you)";y.className="you";el.appendChild(y);}
          if(p.team==="blue"){blueList.appendChild(el);blue++;}
          else if(p.team==="red"){redList.appendChild(el);red++;}
          if(p.voted)voteCount++;
        });

        blueCount.textContent=blue; redCount.textContent=red;
        readyFill.style.width= total? ((voteCount/total)*100+"%"):"0%";
        statusLine.textContent="Players ready to start";
        startCount.textContent=`(${voteCount}/${total} players voted)`;

        const me=players.find(p=>p.id===playerId);
        if(me){
          cancelTeamBtn.classList.toggle("hidden",!me.team);
          readyBtn.disabled=!me.team || me.ready; // disable once ready
          voteBtn.classList.toggle("hidden",!me.ready || me.voted);
          youMeta.textContent= me.team
            ? `On ${me.team.toUpperCase()} team. Ready: ${me.ready?"Yes":"No"}, Voted: ${me.voted?"Yes":"No"}`
            : "You haven’t joined a team yet.";
        }

        // auto-end if fewer than 2 players
        if(total<2){ update(stateRef,{phase:"lobby",t:serverTimestamp()}); }
      });

      // --- Auto-start logic ---
      onValue(playersRef,snap=>{
        const players=snap.val()||{};
        const arr=Object.values(players).filter(p=>p && p.name);
        if(arr.length &&
           arr.every(p=>p.ready && p.voted) &&
           arr.some(p=>p.team==="blue" && p.voted) &&
           arr.some(p=>p.team==="red" && p.voted)){
          let count=3;
          countdownEl.textContent=count;
          countdownEl.classList.add("show");
          const timer=setInterval(()=>{
            count--;countdownEl.textContent=count;
            if(count<=0){
              clearInterval(timer);
              countdownEl.classList.remove("show");
              update(stateRef,{phase:"in_progress",t:serverTimestamp()});
            }
          },1000);
        }
      });
    </script>

    <!-- Map + GeoJSON + GPS -->
    <script type="module">
      import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      // Reuse the same Firebase app initialized in Part 2
      const db = getDatabase();

      // --- Map setup ---
      const map=L.map("map");
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

      // ✅ Load GeoJSON stored as string in Realtime Database
      get(ref(db,"geojson")).then(snap=>{
        const raw=snap.val();
        if(!raw) return;
        try{
          const geojson=JSON.parse(raw);
          const bounds=L.geoJSON(geojson).getBounds();
          map.fitBounds(bounds,{padding:[20,20]});
          L.geoJSON(geojson,{style:{color:"#ccc",fillOpacity:.1}}).addTo(map);
        }catch(e){console.error("Parse error:",e);}
      });

      // --- Zones ---
      const DIVIDING_LAT=47.629536;
      const OUT_OF_BOUNDS_LAT=47.6796281;
      L.polyline([[DIVIDING_LAT,-180],[DIVIDING_LAT,180]],{color:"#222",dashArray:"8 6"}).addTo(map);
      L.polyline([[OUT_OF_BOUNDS_LAT,-180],[OUT_OF_BOUNDS_LAT,180]],{color:"#555",dashArray:"6 4"}).addTo(map);

      // --- GPS + Notifications ---
      const teamLabel=document.getElementById("teamLabel");
      const notify=document.getElementById("notify");
      const beep=document.getElementById("beep");
      let marker=null,accuracyCircle=null,lastSide=null,lastNotifyAt=0;

      const blueIcon=L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",iconSize:[24,24],iconAnchor:[12,12]});
      const redIcon=L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",iconSize:[24,24],iconAnchor:[12,12]});
      const grayIcon=L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png",iconSize:[24,24],iconAnchor:[12,12]});

      function showCrossNotify(side){
        const now=Date.now();if(now-lastNotifyAt<3000) return;lastNotifyAt=now;
        notify.textContent=side==="out"?"Now OUT OF BOUNDS":`Now on ${side.toUpperCase()} side`;
        notify.classList.add("show");
        setTimeout(()=>notify.classList.remove("show"),2500);
        beep.currentTime=0;beep.play().catch(()=>{});
        if("vibrate" in navigator)navigator.vibrate([150,80,150]);
      }
      function sideFromLat(lat){return lat>DIVIDING_LAT?"blue":"red";}
      function updatePosition(lat,lng,accuracy){
        let currentSide;
        if(lat>OUT_OF_BOUNDS_LAT){currentSide="out";teamLabel.textContent="OUT OF BOUNDS";teamLabel.className="gray";}
        else {currentSide=sideFromLat(lat);teamLabel.textContent=currentSide==="blue"?"BLUE side":"RED side";teamLabel.className=currentSide;}
        const icon=currentSide==="blue"?blueIcon:currentSide==="red"?redIcon:grayIcon;
        if(!marker){marker=L.marker([lat,lng],{icon}).addTo(map);accuracyCircle=L.circle([lat,lng],{radius:accuracy||20,opacity:.35}).addTo(map);}
        else {marker.setLatLng([lat,lng]);marker.setIcon(icon);accuracyCircle.setLatLng([lat,lng]).setRadius(accuracy);}
        if(lastSide && lastSide!==currentSide) showCrossNotify(currentSide);lastSide=currentSide;
      }
      if("geolocation" in navigator){
        navigator.geolocation.watchPosition(
          pos=>updatePosition(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy),
          err=>console.error("Location error:",err),
          {enableHighAccuracy:true,maximumAge:1000,timeout:10000}
        );
      }
    </script>

    <!-- Libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  </body>
</html>
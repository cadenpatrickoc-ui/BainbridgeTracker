<!DOCTYPE html>
<html>
  <head>
    <title>Bainbridge CTF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
      html, body { height: 100%; margin: 0; }
      #map { height: 100%; width: 100%; }
      #status {
        position: absolute; top: 10px; left: 10px;
        background: white; padding: 8px 12px; border-radius: 8px;
        font-family: sans-serif; font-size: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 9999;
      }
      #teamLabel {
        position: absolute; top: 50px; left: 10px;
        padding: 8px 12px; border-radius: 8px;
        font-family: sans-serif; font-size: 16px; font-weight: bold;
        color: #fff; z-index: 9999;
      }
      .blue { background: #0b69ff; }
      .red { background: #dc3b3b; }
      .gray { background: #666; }
      .notify {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.75); color: #fff; padding: 8px 12px;
        border-radius: 8px; font-weight: 600; display: none;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <div id="status">⏳ Connecting to Firebase...</div>
    <div id="teamLabel" class="blue">Waiting for location…</div>
    <div id="notify">Crossed line</div>
    <div id="map"></div>

    <!-- Firebase SDK (imported as modules) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD6hkngzSukEdESjhq5KXrSxmc2UjoZLU0",
        authDomain: "bainbridge-ctf.firebaseapp.com",
        projectId: "bainbridge-ctf",
        storageBucket: "bainbridge-ctf.firebasestorage.app",
        messagingSenderId: "627748791933",
        appId: "1:627748791933:web:3c31d762cbaecb7effb314"
      };

      const app = initializeApp(firebaseConfig);

      document.getElementById("status").textContent = "✅ Firebase Connected!";
      console.log("✅ Firebase initialized:", app.name);
    </script>

    <!-- Leaflet & Turf.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Sounds -->
    <audio id="beep" preload="auto">
      <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
    </audio>

    <!-- Map setup with zones -->
    <script>
      const DIVIDING_LAT = 47.629536;       // Blue/Red line
      const OUT_OF_BOUNDS_LAT = 47.6796281; // Out-of-bounds line

      const map = L.map("map");

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Lines
      L.polyline([[DIVIDING_LAT, -180], [DIVIDING_LAT, 180]], {color:"#222", weight:3, dashArray:"8 6"}).addTo(map);
      L.polyline([[OUT_OF_BOUNDS_LAT, -180], [OUT_OF_BOUNDS_LAT, 180]], {color:"#555", weight:2, dashArray:"6 4"}).addTo(map);

      const teamLabel = document.getElementById("teamLabel");
      const statusEl = document.getElementById("status");
      const notify = document.getElementById("notify");
      const beep = document.getElementById("beep");

      let marker=null, accuracyCircle=null, lastSide=null, lastNotifyAt=0;

      function showCrossNotify(side, latlng){
        const now=Date.now(); if(now-lastNotifyAt<3000) return; lastNotifyAt=now;
        notify.textContent = side==="out" ? "Now OUT OF BOUNDS" : `Now on ${side.toUpperCase()} side`;
        notify.style.display="block";
        setTimeout(()=>{notify.style.display="none";},2500);
        beep.currentTime=0; beep.play().catch(()=>{});
        if("vibrate" in navigator) navigator.vibrate([150,80,150]);
        L.popup({autoClose:true, closeButton:false, closeOnClick:false, offset:[0,-10]})
          .setLatLng(latlng).setContent(`<b>${notify.textContent}</b>`).openOn(map);
        setTimeout(()=>map.closePopup(),2000);
      }

      function sideFromLat(lat){ return lat > DIVIDING_LAT ? "blue" : "red"; }

      function updatePosition(lat, lng, accuracy){
        if(!marker){
          marker = L.marker([lat,lng]).addTo(map);
          accuracyCircle = L.circle([lat,lng], {radius:accuracy||20, opacity:0.35}).addTo(map);
        } else {
          marker.setLatLng([lat,lng]);
          accuracyCircle.setLatLng([lat,lng]).setRadius(accuracy);
        }

        let currentSide;
        if(lat > OUT_OF_BOUNDS_LAT){
          currentSide="out";
          teamLabel.textContent="You are OUT OF BOUNDS";
          teamLabel.className="gray";
        } else {
          currentSide=sideFromLat(lat);
          teamLabel.textContent=currentSide==="blue" ? "You are on the BLUE side" : "You are on the RED side";
          teamLabel.className=currentSide;
        }

        statusEl.textContent=`Lat ${lat.toFixed(5)}, Lon ${lng.toFixed(5)} · ±${Math.round(accuracy)}m`;

        if(lastSide && lastSide!==currentSide){
          showCrossNotify(currentSide,[lat,lng]);
        }
        lastSide=currentSide;
      }

      if("geolocation" in navigator){
        navigator.geolocation.watchPosition(
          pos=>updatePosition(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy),
          err=>statusEl.textContent="Location error: "+err.message,
          {enableHighAccuracy:true, maximumAge:1000, timeout:10000}
        );
      }

      // Load local GeoJSON
      fetch("bainbridge.geojson")
        .then(res=>res.json())
        .then(geojson=>{
          const islandBounds = L.geoJSON(geojson).getBounds();
          map.fitBounds(islandBounds,{padding:[20,20]});

          // Red/Blue sides
          geojson.features.forEach(f=>{
            const split = turf.lineSplit(f, turf.lineString([[-123,DIVIDING_LAT],[-122,DIVIDING_LAT]]));
            split.features.forEach(p=>{
              const centroid = turf.centroid(p);
              const lat = centroid.geometry.coordinates[1];
              const isNorth = lat > DIVIDING_LAT && lat <= OUT_OF_BOUNDS_LAT;
              L.geoJSON(p,{style:{
                color:isNorth?"#0b69ff":"#dc3b3b",
                fillColor:isNorth?"#0b69ff":"#dc3b3b",
                fillOpacity:0.15, weight:0
              }}).addTo(map);
            });
          });

          // Gray shading for out-of-bounds
          geojson.features.forEach(f=>{
            const split = turf.lineSplit(f, turf.lineString([[-123,OUT_OF_BOUNDS_LAT],[-122,OUT_OF_BOUNDS_LAT]]));
            split.features.forEach(p=>{
              const centroid = turf.centroid(p);
              const lat = centroid.geometry.coordinates[1];
              if(lat > OUT_OF_BOUNDS_LAT){
                L.geoJSON(p,{style:{fillColor:"#999", fillOpacity:0.2, weight:0}}).addTo(map);
              }
            });
          });
        })
        .catch(err=>console.error("Error loading GeoJSON:",err));
    </script>
  </body>
</html>

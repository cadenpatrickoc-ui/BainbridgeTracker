<!DOCTYPE html>
<html>
  <head>
    <title>Bainbridge CTF — Lobby + Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
      :root{--blue:#0b69ff;--red:#dc3b3b;--gray:#666;}
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
      #app{height:100%}

      /* Topbar on map */
      #topbar{
        position:absolute; top:10px; left:50%; transform:translateX(-50%);
        background:rgba(255,255,255,0.95); border-radius:12px; padding:10px 16px;
        font-size:15px; box-shadow:0 4px 12px rgba(0,0,0,.15);
        display:flex; gap:12px; align-items:center; z-index:1000;
      }
      #firebaseStatus{font-size:13px;color:#333;opacity:1;transition:opacity 1s ease}
      #firebaseStatus.hide{opacity:0}
      #teamLabel{padding:6px 10px;border-radius:6px;font-weight:700;color:#fff}
      .blue{background:var(--blue)} .red{background:var(--red)} .gray{background:var(--gray)}

      #map{position:absolute; inset:0}
      .notify{
        position:absolute; bottom:30px; left:50%; transform:translateX(-50%);
        background:rgba(0,0,0,.8); color:#fff; padding:10px 14px; border-radius:8px;
        font-weight:600; opacity:0; pointer-events:none; transition:opacity .4s, transform .4s;
        z-index:1000;
      }
      .notify.show{opacity:1; transform:translate(-50%,-10px)}

      /* LOBBY */
      #lobby{height:100%; display:flex; align-items:center; justify-content:center;
        background:linear-gradient(180deg,#f7f9fc,#eef2f7); padding:20px;}
      .card{width:min(960px,100%); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:18px;}
      .row{display:grid; grid-template-columns:1fr; gap:16px}
      @media(min-width:800px){ .row{grid-template-columns:1.2fr .8fr} }

      .section{padding:14px 16px; border:1px solid #eaecef; border-radius:12px}
      h1{margin:0 0 10px 0; font-size:20px}
      h2{margin:0 0 8px 0; font-size:16px; color:#333}
      .nameBox{display:flex; gap:10px}
      .nameBox input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #d5d8dd; font-size:15px}
      .btn{border:0; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; background:#111; color:#fff}
      .btn.secondary{background:#f3f4f6; color:#111}
      .btn.blue{background:var(--blue)} .btn.red{background:var(--red)}
      .btn:disabled{opacity:.5; cursor:not-allowed}

      .teams{display:grid; grid-template-columns:1fr 1fr; gap:12px}
      .teamPanel{border:1px solid #e9ecf1; border-radius:12px; overflow:hidden}
      .teamHead{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; color:#fff}
      .teamHead.blue{background:var(--blue)} .teamHead.red{background:var(--red)}
      .teamList{padding:8px 12px; min-height:120px}
      .player{display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px dashed #eee}
      .player:last-child{border-bottom:0}
      .check{color:#1a7f37}
      .you{font-size:12px; color:#555; margin-left:6px}

      .actions{display:flex; gap:8px; flex-wrap:wrap}
      .meta{font-size:13px; color:#444}
      .readyBar{margin-top:10px; background:#f1f3f6; border-radius:10px; overflow:hidden; height:10px}
      .readyFill{background:#16a34a; height:100%; width:0%}

      .countdown{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
        background:rgba(0,0,0,.65); color:#fff; font-size:64px; font-weight:800; z-index:2000}
      .countdown.show{display:flex}
      .hidden{display:none !important}
      #progressBlock{height:100%; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:600}
    </style>
  </head>
  <body>
    <div id="app">
      <!-- LOBBY -->
      <div id="lobby">
        <div class="card">
          <div class="row">
            <div class="section">
              <h1>Join the Game</h1>
              <div id="nameArea" class="nameBox">
                <input id="playerNameInput" placeholder="Enter your name…" maxlength="24"/>
                <button id="saveNameBtn" class="btn">Save</button>
              </div>
              <div id="afterName" class="hidden">
                <div class="actions" style="margin:10px 0">
                  <button id="joinBlue" class="btn blue">Join Blue Team</button>
                  <button id="joinRed" class="btn red">Join Red Team</button>
                  <button id="cancelTeamBtn" class="btn secondary hidden">Cancel</button>
                  <button id="readyBtn" class="btn secondary" disabled>Ready</button>
                  <button id="unreadyBtn" class="btn secondary hidden">Unready</button>
                </div>
                <div class="meta" id="youMeta">You haven’t joined a team yet.</div>
              </div>
            </div>
            <div class="section">
              <h2>Game Status</h2>
              <div class="meta" id="statusLine">Waiting for players…</div>
              <div class="readyBar"><div id="readyFill" class="readyFill"></div></div>
              <div class="actions" style="margin-top:10px">
                <button id="startBtn" class="btn" disabled>Start Game</button>
                <div class="meta" id="startCount">(0/0 players started)</div>
              </div>
            </div>
          </div>
          <div class="section" style="margin-top:12px">
            <div class="teams">
              <div class="teamPanel"><div class="teamHead blue"><div>Blue Team</div><div id="blueCount">0</div></div><div id="blueList" class="teamList"></div></div>
              <div class="teamPanel"><div class="teamHead red"><div>Red Team</div><div id="redCount">0</div></div><div id="redList" class="teamList"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div id="progressBlock" class="hidden">Game in Progress — please wait…</div>
      <div id="countdown" class="countdown">3</div>

      <!-- MAP PHASE -->
      <div id="mapPhase" class="hidden">
        <div id="topbar">
          <span id="firebaseStatus">⏳ Connecting...</span>
          <span id="teamLabel" class="blue">Waiting for location…</span>
        </div>
        <div id="notify" class="notify">Crossed line</div>
        <div id="map"></div>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getDatabase, ref, onValue, set, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD6hkngzSukEdESjhq5KXrSxmc2UjoZLU0",
        authDomain: "bainbridge-ctf.firebaseapp.com",
        projectId: "bainbridge-ctf",
        storageBucket: "bainbridge-ctf.firebasestorage.app",
        messagingSenderId: "627748791933",
        appId: "1:627748791933:web:3c31d762cbaecb7effb314"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const GAME_ID="default";
      const playersRef=ref(db,`games/${GAME_ID}/players`);
      const stateRef=ref(db,`games/${GAME_ID}/state`);
      const geoRef=ref(db,"geojson"); // <-- load island here

      let playerId=localStorage.getItem("ctf_player_id");
      if(!playerId){playerId="p_"+Math.random().toString(36).slice(2,10);localStorage.setItem("ctf_player_id",playerId);}
      onDisconnect(ref(db,`games/${GAME_ID}/players/${playerId}`)).remove();

      // Elements
      const cancelTeamBtn=document.getElementById("cancelTeamBtn");
      const progressBlock=document.getElementById("progressBlock");

      cancelTeamBtn.onclick=()=>update(ref(db,`games/${GAME_ID}/players/${playerId}`),{team:null});

      // Auto end game if <2 players
      onValue(playersRef,snap=>{
        const players=snap.val()||{};
        const total=Object.keys(players).length;
        if(total<2){
          update(stateRef,{phase:"lobby",t:serverTimestamp()});
        }
      });

      // Block late joiners
      onValue(stateRef,snap=>{
        const st=snap.val()||{};
        const phase=st.phase||"lobby";
        if(phase==="in_progress"){
          // If player not in players list yet -> show block
          onValue(ref(db,`games/${GAME_ID}/players/${playerId}`),psnap=>{
            if(!psnap.exists()){
              document.getElementById("lobby").classList.add("hidden");
              progressBlock.classList.remove("hidden");
            }
          });
        } else {
          progressBlock.classList.add("hidden");
        }
      });
    </script>

    <!-- Leaflet & Turf -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Map logic -->
    <script>
      const DIVIDING_LAT=47.629536;
      const OUT_OF_BOUNDS_LAT=47.6796281;
      const map=L.map("map");
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

      function loadIslandFromFirebase(){
        import("https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js").then(({getDatabase,ref,get})=>{
          const db=getDatabase();
          const geoRef=ref(db,"geojson");
          get(geoRef).then(snap=>{
            const geojson=snap.val();
            if(!geojson) return;
            const islandBounds=L.geoJSON(geojson).getBounds();
            map.fitBounds(islandBounds,{padding:[20,20]});
            L.geoJSON(geojson,{style:{color:"#ccc",fillOpacity:.1}}).addTo(map);
          });
        });
      }
      loadIslandFromFirebase();
    </script>
  </body>
</html>
